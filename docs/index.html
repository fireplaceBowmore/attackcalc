<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>언더다크 공격력 계산기</title>
  <style>
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 8px;
    }
    th, td {
      text-align: center;
      vertical-align: middle;
      font-weight: normal;
    }
    /* Remove bold from main table headers */
    .dps-table th, .dps-table td {
      font-weight: normal;
    }
    .info-table th {
      background: #e6e1f2;
      font-weight: bold;
      text-align: center;
    }
    .info-table, .sum-table {
      min-width: 384px;
      width: 432px;
    }
    .info-table td {
      text-align: right;
    }
    .sum-table td {
      text-align: right;
    }
    input[type="number"] { width: 60px; }
    /* Remove number input spinners (all browsers) */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield; /* Firefox */
      appearance: textfield; /* Standard */
    }
    .dps-table thead th {
      background: #e6e1f2;
      font-weight: bold;
    }
    .info-table, .sum-table { width: 100% !important; }
    .info-table td, .info-table th, .sum-table td, .sum-table th { padding: 12px 16px; }
  </style>
</head>
<body>
  <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: flex-start;">
    <div style="flex: 1; min-width: 600px;">
      <div style="display: flex; flex-direction: column; gap: 32px;">
        <table class="dps-table" style="width:100%;">
          <caption></caption>
          <thead>
            <tr>
              <th rowspan="2">아이템</th>
              <th colspan="3">공격력</th>
              <th rowspan="2">공격속도(%)</th>
              <th rowspan="2">치명타 피해(%)</th>
              <th rowspan="2">DPS 증가량<br>(기본)</th>
              <th rowspan="2">DPS 증가량<br>(치명타 적용)</th>
            </tr>
            <tr>
              <th>수치 증가</th>
              <th>퍼센트 증가</th>
              <th>배수 증가</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>투구</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>주 무기</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>보조 무기</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>기타</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>반지</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
          </tbody>
        </table>

        <table class="dps-table" style="width:100%;">
          <caption></caption>
          <thead>
            <tr>
              <th rowspan="2">펫</th>
              <th colspan="3">공격력</th>
              <th rowspan="2">공격속도(%)</th>
              <th rowspan="2">치명타 피해(%)</th>
              <th rowspan="2">DPS 증가량<br>(기본)</th>
              <th rowspan="2">DPS 증가량<br>(치명타 적용)</th>
            </tr>
            <tr>
              <th>수치 증가</th>
              <th>퍼센트 증가</th>
              <th>배수 증가</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>1슬롯</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>2슬롯</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>3슬롯</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
          </tbody>
        </table>

        <table class="dps-table" style="width:100%;">
          <caption></caption>
          <thead>
            <tr>
              <th rowspan="2">성장</th>
              <th colspan="3">공격력</th>
              <th rowspan="2">공격속도(%)</th>
              <th rowspan="2">치명타 피해(%)</th>
              <th rowspan="2">DPS 증가량<br>(기본)</th>
              <th rowspan="2">DPS 증가량<br>(치명타 적용)</th>
            </tr>
            <tr>
              <th>수치 증가</th>
              <th>퍼센트 증가</th>
              <th>배수 증가</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>성장(중앙)</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>성장(외곽)</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>영구 성장</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
          </tbody>
        </table>

        <table class="dps-table" style="width:100%;">
          <caption></caption>
          <thead>
            <tr>
              <th rowspan="2">지원 용병</th>
              <th colspan="3">공격력</th>
              <th rowspan="2">공격속도(%)</th>
              <th rowspan="2">치명타 피해(%)</th>
              <th rowspan="2">DPS 증가량<br>(기본)</th>
              <th rowspan="2">DPS 증가량<br>(치명타 적용)</th>
            </tr>
            <tr>
              <th>수치 증가</th>
              <th>퍼센트 증가</th>
              <th>배수 증가</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>글로벌 버프</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>영웅 선택 버프</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
          </tbody>
        </table>

        <table class="dps-table" style="width:100%;">
          <caption></caption>
          <thead>
            <tr>
              <th rowspan="2">유물</th>
              <th colspan="3">공격력</th>
              <th rowspan="2">공격속도(%)</th>
              <th rowspan="2">치명타 피해(%)</th>
              <th rowspan="2">DPS 증가량<br>(기본)</th>
              <th rowspan="2">DPS 증가량<br>(치명타 적용)</th>
            </tr>
            <tr>
              <th>수치 증가</th>
              <th>퍼센트 증가</th>
              <th>배수 증가</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>1슬롯</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>2슬롯</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>3슬롯</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>4슬롯</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>세트 효과</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
          </tbody>
        </table>

        <table class="dps-table" style="width:100%;">
          <caption></caption>
          <thead>
            <tr>
              <th rowspan="2">구조물⋅소품</th>
              <th colspan="3">공격력</th>
              <th rowspan="2">공격속도(%)</th>
              <th rowspan="2">치명타 피해(%)</th>
              <th rowspan="2">DPS 증가량<br>(기본)</th>
              <th rowspan="2">DPS 증가량<br>(치명타 적용)</th>
            </tr>
            <tr>
              <th>수치 증가</th>
              <th>퍼센트 증가</th>
              <th>배수 증가</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>1구조물</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>2구조물</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>1소품</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>2소품</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>3소품</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
            <tr>
              <th>4소품</th>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td><input type="number"></td>
              <td class="dps-base"></td>
              <td class="dps-crit"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div style="min-width: 360px; margin-left: 24px; display: flex; flex-direction: column; gap: 8px;">
      <table class="info-table" style="width:100%">
        <tr><th colspan="2">기타</th></tr>
        <tr><td>계정 레벨</td><td><input id="accountLevel" type="number" value="" style="width: 80px;" oninput="updateAllDPS()"></td></tr>
        <tr><td>타워 레벨</td><td><input id="towerLevel" type="number" value="" style="width: 80px;" oninput="updateAllDPS()"></td></tr>
        <tr><td>타워 공격력</td><td><input id="towerAtk" type="number" value="24" style="width: 80px;" oninput="updateAllDPS()"></td></tr>
        <tr><td>타워 공격속도</td><td><input id="towerSpd" type="number" value="0.4" style="width: 80px;" oninput="updateAllDPS()"></td></tr>
      </table>
      <table class="sum-table info-table" style="width:100%">
        <tr><th colspan="5">합계</th></tr>
        <tr>
          <td>공격력 수치<br>증가</td>
          <td>공격력 퍼센트<br>증가(%)</td>
          <td>공격력 배수<br>증가</td>
          <td>공격속도<br>증가(%)</td>
          <td>치명타 피해<br>증가(%)</td>
        </tr>
        <tr>
          <td id="sum-atk-flat">0</td>
          <td id="sum-atk-pct">0</td>
          <td id="sum-atk-multi">0</td>
          <td id="sum-spd-flat">0</td>
          <td id="sum-crit-dmg">0</td>
        </tr>
      </table>
      <table class="info-table" style="width:100%">
        <tr><th colspan="2">스테이지 시작 값</th></tr>
        <tr><td>공격력</td><td id="sidebarAtk">0</td></tr>
        <tr><td>치명타</td><td id="sidebarCrit">0</td></tr>
        <tr><td>공격속도</td><td id="sidebarSpd">0</td></tr>
        <tr><td>DPS(기본)</td><td id="sidebarDpsBase">0</td></tr>
        <tr><td>DPS(치명타 적용)</td><td id="sidebarDpsCrit">0</td></tr>
      </table>
    </div>
  </div>

  <script>
    function updateAllDPS() {
      let statColCount = 6;
      let sums = Array(statColCount).fill(0);
      let allRows = [];
      document.querySelectorAll('.dps-table').forEach(table => {
        table.querySelectorAll('tbody tr').forEach(row => {
          let tds = row.querySelectorAll('td');
          let rowStats = [];
          for (let i = 0; i < statColCount; ++i) {
            let input;
            if (i < statColCount - 1) {
              input = tds[i]?.querySelector('input');
            } else {
              let inputs = row.querySelectorAll('input');
              input = inputs[inputs.length - 1];
            }
            let val = input ? parseFloat(input.value) || 0 : 0;
            sums[i] += val;
            rowStats.push(val);
          }
          allRows.push({row, rowStats});
        });
      });

      // Update sum table
      document.getElementById('sum-atk-flat').textContent = sums[0] ? sums[0].toLocaleString() : '0';
      document.getElementById('sum-atk-pct').textContent = sums[1] ? sums[1].toLocaleString() : '0';
      document.getElementById('sum-atk-multi').textContent = sums[2] ? sums[2].toLocaleString() : '0';
      document.getElementById('sum-spd-flat').textContent = sums[3] ? sums[3].toLocaleString() : '0';
      document.getElementById('sum-crit-dmg').textContent = sums[5] ? sums[5].toLocaleString() : '0';

      const accountLevel = parseFloat(document.getElementById('accountLevel').value) || 0;
      const towerLevel = parseFloat(document.getElementById('towerLevel').value) || 1;
      const towerAtk = parseFloat(document.getElementById('towerAtk').value) || 0;
      const towerSpd = parseFloat(document.getElementById('towerSpd').value) || 0;

      // Calculate total DPS with all rows
      const sumAtkFlat = sums[0];
      const sumAtkPct = sums[1];
      const sumAtkMulti = sums[2];
      const sumSpdFlat = sums[3];
      const sumCritDmg = sums[5];

      // Main DPS calculation (with all rows)
      const atk = (towerAtk + sumAtkFlat) * (1 + sumAtkMulti + accountLevel/100) * (1 + sumAtkPct/100 + 0.5*(towerLevel-1));
      const spd = towerSpd * (1 + sumSpdFlat / 100);
      const dpsBase = atk * spd;
      const dpsCrit = dpsBase * (1.5 + sumCritDmg / 100);

      document.getElementById('sidebarAtk').textContent = Math.round(atk).toLocaleString();
      document.getElementById('sidebarCrit').textContent = sumCritDmg ? (sumCritDmg + 150).toLocaleString()+'%' : '0%';
      document.getElementById('sidebarSpd').textContent = spd.toLocaleString();
      document.getElementById('sidebarDpsBase').textContent = Math.round(dpsBase).toLocaleString();
      document.getElementById('sidebarDpsCrit').textContent = Math.round(dpsCrit).toLocaleString();

      // Per-row DPS 증가량 계산 (percentage only)
      allRows.forEach(({row, rowStats}, idx) => {
        // Remove this row's values from sums
        const flat = sumAtkFlat - rowStats[0];
        const pct = sumAtkPct - rowStats[1];
        const multi = sumAtkMulti - rowStats[2];
        const spdFlat = sumSpdFlat - rowStats[3];
        const crit = sumCritDmg - rowStats[5];
        // DPS without this row
        const atk_ = (towerAtk + flat) * (1 + multi + accountLevel/100) * (1 + pct/100 + 0.5*(towerLevel-1));
        const spd_ = towerSpd * (1 + spdFlat / 100);
        const dpsBase_ = atk_ * spd_;
        const dpsCrit_ = dpsBase_ * (1.5 + crit / 100);
        // Percentage increase
        let dpsBasePct = dpsBase_ === 0 ? 0 : ((dpsBase - dpsBase_) / dpsBase_ * 100);
        let dpsCritPct = dpsCrit_ === 0 ? 0 : ((dpsCrit - dpsCrit_) / dpsCrit_ * 100);
        let tds = row.querySelectorAll('td');
        let dpsBaseCell = tds[tds.length - 2];
        let dpsCritCell = tds[tds.length - 1];
        dpsBaseCell.innerHTML = dpsBase_ === 0 ? '' : `<span style='font-size:0.9em;'>${dpsBasePct.toFixed(2)}%</span>`;
        dpsCritCell.innerHTML = dpsCrit_ === 0 ? '' : `<span style='font-size:0.9em;'>${dpsCritPct.toFixed(2)}%</span>`;
      });
    }
    document.addEventListener('input', function(e) {
      if (e.target.matches('input[type="number"]')) updateAllDPS();
    });
    window.addEventListener('DOMContentLoaded', updateAllDPS);

    // Save all inputs on change
    document.addEventListener('input', function() {
      const allInputs = Array.from(document.querySelectorAll('input[type=\"number\"]'));
      const values = allInputs.map(input => input.value);
      localStorage.setItem('statInputs', JSON.stringify(values));
    });

    // Load all inputs on page load
    window.addEventListener('DOMContentLoaded', function() {
      const values = JSON.parse(localStorage.getItem('statInputs') || '[]');
      const allInputs = Array.from(document.querySelectorAll('input[type=\"number\"]'));
      allInputs.forEach((input, i) => {
        if (values[i] !== undefined) input.value = values[i];
      });
      updateAllDPS(); // recalculate after loading
    });
  </script>
</body>
</html>
